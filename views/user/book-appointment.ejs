<!-- <h1>Book New Appointment</h1>

<form action="/user/appointments" method="POST" class="appointment-form">
    <div class="form-group">
        <label for="testId">Select Test:</label>
        <select id="tests" name="tests" multiple required>
            <% tests.forEach(test => { %>
                <option value="<%= test._id %>">
                    <%= test.name %> - â‚¹<%= test.price %> (<%= test.duration %> hours)
                </option>
            <% }) %>
        </select>
    </div>
    
    <div class="form-group">
        <label for="appointmentDate">Appointment Date:</label>
        <input type="datetime-local" id="appointmentDate" name="appointmentDate" required>
    </div>
    
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Book Appointment</button>
        <a href="/user/appointments" class="btn btn-secondary">Cancel</a>
    </div>
</form> -->
<!-- <h1>Book New Appointment</h1>

<form action="/user/appointments" method="POST" class="appointment-form"> -->
    <!-- 1ï¸âƒ£ Select Lab -->
    <!-- <div class="form-group">
        <label for="lab">Select Lab:</label>
        <select id="lab" name="labId" class="form-control" required>
            <option value="">-- Select Lab --</option>
            <% labs.forEach(lab => { %>
                <option value="<%= lab._id %>"><%= lab.name %> - <%= lab.address %></option>
            <% }) %>
        </select>
    </div> -->

    <!-- 2ï¸âƒ£ Select Tests -->
    <!-- <div class="form-group">
        <label for="tests">Select Tests:</label>
        <select id="tests" name="tests" multiple class="form-control" required>
            <% tests.forEach(test => { %>
                <option value="<%= test._id %>" data-price="<%= test.price %>">
                    <%= test.name %> - â‚¹<%= test.price %> (<%= test.duration %> hours)
                </option>
            <% }) %>
        </select>
        <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple tests.</small>
    </div> -->

    <!-- 3ï¸âƒ£ Appointment Date & Time -->
    <!-- <div class="form-group">
        <label for="appointmentDate">Appointment Date & Time:</label>
        <input type="datetime-local" id="appointmentDate" name="appointmentDate" required class="form-control">
    </div> -->

    <!-- 4ï¸âƒ£ Total Price -->
    <!-- <div class="form-group">
        <label>Total Price (â‚¹):</label>
        <input type="text" id="totalPrice" readonly class="form-control" value="0">
    </div> -->

    <!-- 5ï¸âƒ£ Form Buttons -->
    <!-- <div class="form-actions">
        <button type="submit" class="btn btn-primary">Book Appointment</button>
        <a href="/user/appointments" class="btn btn-secondary">Cancel</a>
    </div>
</form> -->

<!-- âœ… JS for Total Calculation + Date Validation -->
<!-- <script>
    const testsSelect = document.getElementById('tests');
    const totalInput = document.getElementById('totalPrice');
    const dateInput = document.getElementById('appointmentDate');

    // ðŸ”¹ Set minimum datetime to current time
    function setMinDateTime() {
        const now = new Date();
        const localISOTime = new Date(now.getTime() - now.getTimezoneOffset() * 60000)
            .toISOString()
            .slice(0, 16);
        dateInput.min = localISOTime;
    }

    // ðŸ”¹ Validate if selected date/time is in the future
    dateInput.addEventListener('change', () => {
        const selected = new Date(dateInput.value);
        const now = new Date();
        if (selected < now) {
            alert('Please select a future date and time.');
            dateInput.value = '';
        }
    });

    // ðŸ”¹ Auto-calculate total â‚¹
    testsSelect.addEventListener('change', () => {
        let total = 0;
        Array.from(testsSelect.selectedOptions).forEach(option => {
            total += parseFloat(option.getAttribute('data-price')) || 0;
        });
        totalInput.value = total.toFixed(2);
    });

    // Run setup on page load
    setMinDateTime();
</script> -->
<!-- <script>
    const testsSelect = document.getElementById('tests');
    const totalInput = document.getElementById('totalPrice');
    const dateInput = document.getElementById('appointmentDate');

    // ðŸ”¹ Set minimum datetime to current time (ISO format adjusted for local timezone)
    function setMinDateTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset()); // adjust for timezone
        const localISOTime = now.toISOString().slice(0, 16);
        dateInput.min = localISOTime;
    }

    // ðŸ”¹ Validate that selected datetime is >= current time
    dateInput.addEventListener('change', () => {
        const selected = new Date(dateInput.value);
        const now = new Date();
        if (selected.getTime() < now.getTime() - 60000) { // allow up to 1 min difference
            alert('Please select a current or future date and time.');
            dateInput.value = '';
        }
    });

    // ðŸ”¹ Auto-calculate total â‚¹
    testsSelect.addEventListener('change', () => {
        let total = 0;
        Array.from(testsSelect.selectedOptions).forEach(option => {
            total += parseFloat(option.getAttribute('data-price')) || 0;
        });
        totalInput.value = total.toFixed(2);
    });

    // Run setup on page load
    setMinDateTime();
</script> -->

<h1>Book New Appointment</h1>

<form action="/user/appointments" method="POST" class="appointment-form">
    <!-- 1ï¸âƒ£ Select Lab -->
    <div class="form-group">
        <label for="lab">Select Lab:</label>
        <select id="lab" name="labId" class="form-control" required>
            <option value="">-- Select Lab --</option>
            <% labs.forEach(lab => { %>
                <option value="<%= lab._id %>"><%= lab.name %> - <%= lab.address %></option>
            <% }) %>
        </select>
    </div>

    <!-- 2ï¸âƒ£ Select Tests -->
    <div class="form-group">
        <label for="tests">Select Tests:</label>
        <select id="tests" name="tests" multiple class="form-control" required>
            <% tests.forEach(test => { %>
                <option value="<%= test._id %>" data-price="<%= test.price %>">
                    <%= test.name %> - â‚¹<%= test.price %> (<%= test.duration %> hours)
                </option>
            <% }) %>
        </select>
        <small class="text-muted">Hold Ctrl (Windows) or Command (Mac) to select multiple tests.</small>
    </div>

    <!-- 3ï¸âƒ£ Appointment Date & Time -->
    <div class="form-group">
        <label for="appointmentDate">Appointment Date & Time:</label>
        <input type="datetime-local" id="appointmentDate" name="appointmentDate" required class="form-control">
        <small class="text-muted">Please select a current or future date and time.</small>
    </div>

    <!-- 4ï¸âƒ£ Total Price -->
    <div class="form-group">
        <label>Total Price (â‚¹):</label>
        <input type="text" id="totalPrice" readonly class="form-control" value="0">
    </div>

    <!-- 5ï¸âƒ£ Form Buttons -->
    <div class="form-actions">
        <button type="submit" class="btn btn-primary">Book Appointment</button>
        <a href="/user/appointments" class="btn btn-secondary">Cancel</a>
    </div>
</form>

<script>
    const testsSelect = document.getElementById('tests');
    const totalInput = document.getElementById('totalPrice');
    const dateInput = document.getElementById('appointmentDate');

    // ðŸ”¹ Set minimum datetime to current local time
    function setMinDateTime() {
        const now = new Date();
        now.setMinutes(now.getMinutes() - now.getTimezoneOffset());
        const localISOTime = now.toISOString().slice(0, 16);
        dateInput.min = localISOTime;
    }

    // ðŸ”¹ Validate that selected date/time is in the future
    dateInput.addEventListener('change', () => {
        const selected = new Date(dateInput.value);
        const now = new Date();
        if (selected.getTime() < now.getTime() - 60000) { // allow slight delay margin
            alert('Please select a future date and time.');
            dateInput.value = '';
        }
    });

    // ðŸ”¹ Auto-calculate total price
    testsSelect.addEventListener('change', () => {
        let total = 0;
        Array.from(testsSelect.selectedOptions).forEach(option => {
            total += parseFloat(option.getAttribute('data-price')) || 0;
        });
        totalInput.value = total.toFixed(2);
    });

    // Initialize min datetime on load
    setMinDateTime();
</script>
